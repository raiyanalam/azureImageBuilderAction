# https://help.github.com/en/actions/configuring-and-managing-workflows/persisting-workflow-data-using-artifacts
# test run

name: Share data between jobs

on: [push]

jobs:
  job_1: 
    name: Azure Image builder run 
    runs-on: ubuntu-latest
    env:
      subscriptionID: "xxxx-xxxxx"
      ######Source image details########### 
      type: "PlatformImage"
      publisher: "Canonical"
      offer": "UbuntuServer"
      sku: "18.04-LTS"
      version: "latest"    
     ######Target Distribution details###########
      distributor-resource-group: "iblinuxGalleryRG"
      image-gallery-name: "iblinuxGallery"
      image-definition: "iblinux"
      image-version: "0.1"
      image-location: "West US2"
    ########Custom Scipt location#######
      customizer[0].type: "Shell"
      customizer[0].name: "RunScriptFromSource"
      customizer[0].scriptUri: "https://raw.githubusercontent.com/danielsollondon/azvmimagebuilder/master/quickquickstarts/customizeScript.sh"
    
    steps:  
        - name: 'Checkout Github Action' 
          uses: actions/checkout@master

        - name: azure authentication
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}
             
        - name: azure Image builder 
          uses: azure/cli@v1
        - run: |
            az role assignment create --assignee cf32a0cc-373c-47c9-9156-0db11f6a6dfc \
              --role Contributor --scope /subscriptions/<subscriptionID>/resourceGroups/<distributorResourceGroup>
            if {az group create -n ${distributor-resource-group} -l ${image-location} } 
            az sig create -g ${distributor-resource-group}  --gallery-name ${image-gallery-name}
            az sig image-definition create -g ${distributor-resource-group} --gallery-name ${image-gallery-name} \
              --gallery-image-definition ${image-definiation} --publisher ${publisher} --offer ${offer}  --sku ${sku}  --os-type "linux"
         
        - name: 'Update AIB template with inputs'
          run: |
            curl https://raw.githubusercontent.com/raiyanalam/azureImageBuilderAction/master/PlatformImageTemplate-UbuntuLinuxCanonical.json -o PlatformImageTemplate-UbuntuLinuxCanonical.json
            sed -i -e "s/<subscriptionID>/${subscriptionID}/g" PlatformImageTemplate-UbuntuLinuxCanonical.json
            sed -i -e "s/<rgName>/${distributor-resource-group}/g" PlatformImageTemplate-UbuntuLinuxCanonical.json
            sed -i -e "s/<region>/${image-location}/g" PlatformImageTemplate-UbuntuLinuxCanonical.json
            sed -i -e "s/<imageName>/${image-definition}/g" PlatformImageTemplate-UbuntuLinuxCanonical.json
            sed -i -e "s/<runOutputName>/$run-output-name/g" PlatformImageTemplate-UbuntuLinuxCanonical.json
                      
        - name: azure Image builder
#         uses: azure/imagebuilder@v0
          run: |
                              
            
                   
    
